---
title: "Test Rmd File"
author: "Daniel Allington"
date: "2026-02-10"
output: html_document
---

In this Rmd file, we develop and test basic bits of code.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(dplyr)
library(purrr)
library(ggplot2)
```

```{r}
population.p <- .5
population.N <- 10000

population <- c(
  rep(1, population.N * population.p), 
  rep(0, population.N * (1 - population.p)))
```

Bib ref for complement function:

@MISC {313138,
    TITLE = {Generate a random variable with a defined correlation to an existing variable(s)},
    AUTHOR = {whuber (https://stats.stackexchange.com/users/919/whuber)},
    HOWPUBLISHED = {Cross Validated},
    NOTE = {URL:https://stats.stackexchange.com/q/313138 (version: 2021-01-14)},
    EPRINT = {https://stats.stackexchange.com/q/313138},
    URL = {https://stats.stackexchange.com/q/313138}
}

```{r}
visualise.samples <- function(d) {
  sample.summary <- d %>%
    filter(
      Sample != 'Pop.'
    ) %>%
    summarise(
      SDm1 = mean(p) - sd(p),
      Mean = mean(p),
      SDp1 = mean(p) + sd(p)
    )

  d %>%
    mutate(
      Sample = factor(
        Sample,
        levels = c('Pop.', d$Sample[d$Sample!='Pop.']) %>% rev
      ),
      Colour = ifelse(
        Sample == 'Pop.',
        'Pop.', 'Sample'
      )
    ) %>%
    ggplot(
      aes(x = Sample, y = p, colour = Colour, fill = Colour)
    ) +
    geom_col() +
    geom_hline(
      yintercept = sample.summary$SDm1,
      size = 1,
      linetype = 'dotted'
    ) +
    geom_hline(
      yintercept = sample.summary$Mean,
      size = 1,
      linetype = 'dashed'
    ) +
    geom_hline(
      yintercept = sample.summary$SDp1,
      size = 1,
      linetype = 'dotted'
    ) +
    scale_x_discrete('') +
    scale_y_continuous('', limits = c(0,1), labels = scales::percent) +
    scale_colour_manual(values = c('Pop.' = 'darkred', 'Sample' = 'darkblue'), guide = 'none') +
    scale_fill_manual(values = c('Pop.' = 'pink', 'Sample' = 'lightblue'), guide = 'none') +
    coord_flip() +
    theme_bw()
}

complement <- function(x, rho) {
  y <- rnorm(length(x))
  x.perp <- residuals(lm(y ~ x))
  rho * sd(x.perp) * x + x.perp * sd(y) * sqrt(1 - rho^2)
}

take.sample <- function(x, n, data.defect.correlation) {
  proportion.to.sample <- n / length(x)
  y <- complement(x, data.defect.correlation * 2)
  sampling.p <- ecdf(y)(y) * proportion.to.sample * 2
  sample(x, size = n, replace = FALSE, prob = sampling.p)
}

samples <- (1:10) %>%
  map_dbl(
    function(x) {
      mean(take.sample(population, 500, -.05))
    }
  )

tibble(
  Sample = c('Pop.', 1:length(samples)), 
  p = c(mean(population), samples)
  ) %>%
  visualise.samples
```
